#### 二阶段提交（2PC)

**1.预提交，**即尝试执行事务操作，并将undo和redo日志计入事务日志。然后向协调者反馈执行结果，然后再回滚为初始状态。类似于投票

**2.协调者根据反馈结果**，若都为yes，则执行事务提交，即向所有节点发出commit请求，节点收到请求，正式执行事务提交操作。执行成功后向协调者发送ACK消息。若有一个接地那反馈NO或者等待超时，即**未收到全部ACK**，则会中断事务。

**中断事务：**即向所有节点发出rollback请求，节点根据undo日志回滚，然后返回ACK。

![1554299409255](C:\Users\ASUS\AppData\Roaming\Typora\typora-user-images\1554299409255.png)

缺点：

1.同步阻塞：即在执行事务过程中，所有逻辑都处于阻塞状态，参与者都在等待其他参与者的响应

2.单点问题：协调者很关键，若在阶段二出问题，则其他参与者一致处于锁定状态。例如只有部分commit，则导致部分参与者未收到commit请求，则导致不一致

3.不一致：

4.太保守：缺少容错机制，即只要一个参与者故障，协调者始终无法获取参与者的响应，则只能根据自身超时机制进行中断事务。即任意节点失败都导致整个事务失败。

#### 三阶段提交（3PC)

1.CanCommit：反馈yes或者no相应

2.PreCommit：全部返回yes响应后执行事务预提交，执行成功会返回ACK，否则就不会相应。协调者有计时器判断超时。若超时或收到了No响应会中断事务

3.DoCommit：真正进行事务提交，完成后返回ACK。若收到no响应或者超时，则执行undo日志来进行回滚进行事务中断。

优点：相对于2PC降低了参与者的阻塞范围，因为多了一个阶段，拉长了。**但能保证在前二个阶段中在单点故障后达成一致**

缺点：在阶段三时会出现同样问题，即接收到PreCommit后出现问题或者协调者故障，则会导致数据的不一致性。